#!/usr/bin/env ply
/*
 * opensnoop    trace file opens.
 */

kprobe:do_sys_open
{
    @path[tid()] = arg(1);
}

kretprobe:do_sys_open / @path[tid()] /
{
    if (retval() > 0) {
        fd = retval();
        errno = 0;
    } else {
        fd = -1;
        errno = -1 * retval();
    }

    printf("%-6d %-16s %4d %3d %s\n", pid(), comm(), fd, errno,
	   mem(@path[tid()], "128s"));

    @path[tid()] = nil;
}
